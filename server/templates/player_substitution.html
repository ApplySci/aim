{% extends "runbase.html" %}

{% block title %}Manage Player Substitutions - {{ current_user.live_tournament.title }}{% endblock %}

{% block content %}
<h2>Manage Player Substitutions</h2>

<div id="playerManagement" style="display: flex; justify-content: space-between;">
    <div id="currentPlayersSection" style="position: relative;">
        <h3>Current Players</h3>
        <select id="currentPlayerSelect" multiple size="16" style="width: 300px;"></select>
        <button id="moveToDropped" style="position: absolute; top: 30px; right: -30px;">→</button>
    </div>
    <div id="droppedPlayersSection" style="position: relative;">
        <h3>Dropped Out Players</h3>
        <button id="moveToActive" style="position: absolute; top: 30px; left: -30px;">←</button>
        <select id="droppedPlayerSelect" multiple size="16" style="width: 300px;"></select>
    </div>
</div>

<div id="substitutesSection"></div>
    <h3>Substitutes</h3>
    <ul id="substitutesList"></ul>
</div>
<p>
    <button id="calculateSubstitutions">Calculate Substitutions</button>
    <button id="undoSubstitution" style="display: none;">Undo Last Substitution</button>
</p>
<div id="substitutionPreview" style="display: none;"></div>
    <h3>Substitution Preview</h3>
    <pre id="previewContent"></pre>
    <button id="confirmSubstitutions">Confirm Substitutions</button>
    <button id="cancelSubstitutions">Cancel</button>
</div>
<p><a href="/run/">Back to main Run Tournament page</a></p>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentPlayerSelect = document.getElementById('currentPlayerSelect');
    const droppedPlayerSelect = document.getElementById('droppedPlayerSelect');
    const moveToDroppedButton = document.getElementById('moveToDropped');
    const moveToActiveButton = document.getElementById('moveToActive');
    const calculateButton = document.getElementById('calculateSubstitutions');
    const confirmButton = document.getElementById('confirmSubstitutions');
    const cancelButton = document.getElementById('cancelSubstitutions');
    const undoButton = document.getElementById('undoSubstitution');
    const substitutionPreview = document.getElementById('substitutionPreview');
    const previewContent = document.getElementById('previewContent');

    let allPlayers = [];
    let currentPlayers = [];
    let droppedPlayers = [];
    let substitutes = [];

    // Fetch players data
    fetch('{{ url_for("run.sub.get_players_data") }}')
        .then(response => response.json())
        .then(data => {
            allPlayers = data.players;
            currentPlayers = allPlayers.filter(p => p.is_current);
            droppedPlayers = allPlayers.filter(p => !p.is_current && p.seating_id);
            substitutes = allPlayers.filter(p => !p.is_current && !p.seating_id);
            renderPlayers();
        });

    function renderPlayers() {
        // Render current players
        currentPlayerSelect.innerHTML = '';
        currentPlayers.forEach(player => {
            const option = new Option(`${player.name} (ID: ${player.registration_id})`, player.registration_id);
            currentPlayerSelect.add(option);
        });

        // Render dropped players
        droppedPlayerSelect.innerHTML = '';
        droppedPlayers.forEach(player => {
            const option = new Option(`${player.name} (ID: ${player.registration_id})`, player.registration_id);
            droppedPlayerSelect.add(option);
        });

        // Render substitutes
        const substitutesList = document.getElementById('substitutesList');
        substitutesList.innerHTML = '';
        substitutes.forEach(player => {
            const li = document.createElement('li');
            li.textContent = `${player.name} (ID: ${player.registration_id})`;
            substitutesList.appendChild(li);
        });
    }

    moveToDroppedButton.addEventListener('click', function() {
        Array.from(currentPlayerSelect.selectedOptions).forEach(option => {
            const player = currentPlayers.find(p => p.registration_id === option.value);
            if (player) {
                player.is_current = false;
                currentPlayers = currentPlayers.filter(p => p.registration_id !== player.registration_id);
                droppedPlayers.push(player);
            }
        });
        renderPlayers();
    });

    moveToActiveButton.addEventListener('click', function() {
        Array.from(droppedPlayerSelect.selectedOptions).forEach(option => {
            const player = droppedPlayers.find(p => p.registration_id === option.value);
            if (player) {
                player.is_current = true;
                droppedPlayers = droppedPlayers.filter(p => p.registration_id !== player.registration_id);
                currentPlayers.push(player);
            }
        });
        renderPlayers();
    });

    function movePlayerBack(player) {
        player.is_current = true;
        droppedPlayers = droppedPlayers.filter(p => p.registration_id !== player.registration_id);
        currentPlayers.push(player);
        renderPlayers();
    }

    function removeSubstitute(player) {
        substitutes = substitutes.filter(p => p.registration_id !== player.registration_id);
        renderPlayers();
    }

    calculateButton.addEventListener('click', function() {
        fetch('/run/sub/calculate_substitutions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dropped_out: droppedPlayers.map(p => p.seating_id),
                substitutes: substitutes.map(p => p.registration_id),
            }),
        })
        .then(response => response.json())
        .then(data => {
            previewContent.textContent = JSON.stringify(data.preview, null, 2);
            substitutionPreview.style.display = 'block';
        });
    });

    confirmButton.addEventListener('click', function() {
        fetch('/run/sub/confirm_substitutions', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Substitutions applied successfully');
                undoButton.style.display = 'block';
                substitutionPreview.style.display = 'none';
                // Refresh player lists
                location.reload();
            } else {
                alert('Error applying substitutions');
            }
        });
    });

    cancelButton.addEventListener('click', function() {
        substitutionPreview.style.display = 'none';
    });

    undoButton.addEventListener('click', function() {
        fetch('/run/sub/undo_substitution', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Last substitution undone');
                location.reload();
            } else {
                alert('Error undoing substitution');
            }
        });
    });
});
</script>
{% endblock %}
