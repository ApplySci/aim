{% extends "runbase.html" %}

{% block title %}Manage Player Substitutions - {{ current_user.live_tournament.title }}{% endblock %}

{% block content %}
<h2>Manage Player Substitutions</h2>

<div id="searchContainer">
    <input type="text" id="playerSearch" placeholder="Search players...">
</div>

<div id="playerLists">
    <div id="currentPlayers">
        <h3>Current Players</h3>
        <ul id="currentPlayersList"></ul>
    </div>
    <div id="substitutes">
        <h3>Substitutes</h3>
        <ul id="substitutesList"></ul>
    </div>
</div>

<button id="calculateSubstitutions">Calculate Substitutions</button>

<div id="substitutionPreview" style="display: none;">
    <h3>Substitution Preview</h3>
    <pre id="previewContent"></pre>
    <button id="confirmSubstitutions">Confirm Substitutions</button>
    <button id="cancelSubstitutions">Cancel</button>
</div>

<button id="undoSubstitution" style="display: none;">Undo Last Substitution</button>

<a href="{{ url_for('run.tournament') }}">Back to Tournament Management</a>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const playerSearch = document.getElementById('playerSearch');
    const currentPlayersList = document.getElementById('currentPlayersList');
    const substitutesList = document.getElementById('substitutesList');
    const calculateButton = document.getElementById('calculateSubstitutions');
    const confirmButton = document.getElementById('confirmSubstitutions');
    const cancelButton = document.getElementById('cancelSubstitutions');
    const undoButton = document.getElementById('undoSubstitution');
    const substitutionPreview = document.getElementById('substitutionPreview');
    const previewContent = document.getElementById('previewContent');

    let allPlayers = [];
    let currentPlayers = [];
    let substitutes = [];
    let droppedOutPlayers = [];

    // Fetch players data
    fetch('{{ url_for("run.get_players_data") }}')
        .then(response => response.json())
        .then(data => {
            allPlayers = data.players;
            currentPlayers = data.current_players;
            substitutes = data.substitutes;
            renderPlayers();
        });

    function renderPlayers() {
        currentPlayersList.innerHTML = '';
        substitutesList.innerHTML = '';

        currentPlayers.forEach(player => {
            const li = createPlayerListItem(player, 'current');
            currentPlayersList.appendChild(li);
        });

        substitutes.forEach(player => {
            const li = createPlayerListItem(player, 'substitute');
            substitutesList.appendChild(li);
        });
    }

    function createPlayerListItem(player, type) {
        const li = document.createElement('li');
        li.textContent = `${player.name} (ID: ${player.id})`;
        const button = document.createElement('button');
        button.textContent = type === 'current' ? 'Drop Out' : 'Remove';
        button.onclick = () => togglePlayerStatus(player, type);
        li.appendChild(button);
        return li;
    }

    function togglePlayerStatus(player, type) {
        if (type === 'current') {
            currentPlayers = currentPlayers.filter(p => p.id !== player.id);
            droppedOutPlayers.push(player);
        } else {
            substitutes = substitutes.filter(p => p.id !== player.id);
        }
        renderPlayers();
    }

    playerSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredPlayers = allPlayers.filter(player => 
            player.name.toLowerCase().includes(searchTerm) ||
            player.id.toString().includes(searchTerm)
        );
        // Update the lists with filtered players
        // (You may want to create a separate function for this)
    });

    calculateButton.addEventListener('click', function() {
        fetch('{{ url_for("run.calculate_substitutions") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dropped_out: droppedOutPlayers.map(p => p.id),
                substitutes: substitutes.map(p => p.id),
            }),
        })
        .then(response => response.json())
        .then(data => {
            previewContent.textContent = JSON.stringify(data.preview, null, 2);
            substitutionPreview.style.display = 'block';
        });
    });

    confirmButton.addEventListener('click', function() {
        fetch('{{ url_for("run.confirm_substitutions") }}', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Substitutions applied successfully');
                undoButton.style.display = 'block';
                substitutionPreview.style.display = 'none';
                // Refresh player lists
                location.reload();
            } else {
                alert('Error applying substitutions');
            }
        });
    });

    cancelButton.addEventListener('click', function() {
        substitutionPreview.style.display = 'none';
    });

    undoButton.addEventListener('click', function() {
        fetch('{{ url_for("run.undo_substitution") }}', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Last substitution undone');
                location.reload();
            } else {
                alert('Error undoing substitution');
            }
        });
    });
});
</script>
{% endblock %}
