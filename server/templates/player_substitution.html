{% extends "runbase.html" %}

{% block title %}Manage Player Substitutions - {{ current_user.live_tournament.title }}{% endblock %}

{% block content %}
<h2>Manage Player Substitutions</h2>

<p>{{ completed_rounds}} hanchan completed. Substitutions will be made for all hanchan from {{ completed_rounds + 1 }} onwards</p>

<div id="playerManagement" style="display: flex; justify-content: flex-start; gap: 100px;">
    <div id="currentPlayersSection" style="position: relative; width: 300px;">
        <h3>Current Players</h3>
        <select id="currentPlayerSelect" multiple size="16" style="width: 100%;"></select>
        <button id="moveToDropped" style="position: absolute; top: 55px; right: -40px;">→</button>
    </div>
    <div id="droppedPlayersSection" style="position: relative; width: 300px;">
        <h3>Dropped Out Players</h3>
        <button id="moveToActive" style="position: absolute; top: 55px; left: -40px;">←</button>
        <select id="droppedPlayerSelect" multiple style="width: 100%;"></select>
    </div>
</div>

<p>
    <button id="calculateSubstitutions">Calculate Substitutions</button>
    <button id="undoSubstitution" style="display: none;">Undo Last Substitution</button>
</p>
<div id="substitutionPreview" style="display: none;">
    <h3>Substitution Preview</h3>
    <pre id="previewContent"></pre>
    <button id="confirmSubstitutions">Confirm Substitutions</button>
    <button id="cancelSubstitutions">Cancel</button>
</div>
<p><a href="{{ url_for('run.run_tournament') }}">Back to main Run Tournament page</a></p>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentPlayerSelect = document.getElementById('currentPlayerSelect');
    const droppedPlayerSelect = document.getElementById('droppedPlayerSelect');
    const moveToDroppedButton = document.getElementById('moveToDropped');
    const moveToActiveButton = document.getElementById('moveToActive');
    const calculateButton = document.getElementById('calculateSubstitutions');
    const confirmButton = document.getElementById('confirmSubstitutions');
    const cancelButton = document.getElementById('cancelSubstitutions');
    const undoButton = document.getElementById('undoSubstitution');
    const substitutionPreview = document.getElementById('substitutionPreview');
    const previewContent = document.getElementById('previewContent');

    // Initialize players data from server-provided data
    let allPlayers = {{ players|tojson }};
    let currentPlayers = allPlayers.filter(p => p.is_current);
    let droppedPlayers = allPlayers.filter(p => !p.is_current && p.seating_id);
    let substitutes = allPlayers.filter(p => !p.is_current && !p.seating_id);
    
    // Render players immediately
    renderPlayers();

    function renderPlayers() {
        // Sort players alphabetically by name
        currentPlayers.sort((a, b) => a.name.localeCompare(b.name));
        droppedPlayers.sort((a, b) => a.name.localeCompare(b.name));

        // Render current players
        currentPlayerSelect.innerHTML = '';
        currentPlayers.forEach(player => {
            const option = new Option(`${player.name} (ID: ${player.registration_id})`, player.registration_id);
            currentPlayerSelect.add(option);
        });

        // Render dropped players
        droppedPlayerSelect.innerHTML = '';
        droppedPlayers.forEach(player => {
            const option = new Option(`${player.name} (ID: ${player.registration_id})`, player.registration_id);
            droppedPlayerSelect.add(option);
        });

        // Adjust the size of droppedPlayerSelect
        const maxSize = parseInt(currentPlayerSelect.getAttribute('size'));
        droppedPlayerSelect.size = Math.min(Math.max(droppedPlayers.length, 1), maxSize);
    }

    moveToDroppedButton.addEventListener('click', function() {
        Array.from(currentPlayerSelect.selectedOptions).forEach(option => {
            const player = currentPlayers.find(p => p.registration_id === option.value);
            if (player) {
                player.is_current = false;
                currentPlayers = currentPlayers.filter(p => p.registration_id !== player.registration_id);
                droppedPlayers.push(player);
            }
        });
        renderPlayers();
    });

    moveToActiveButton.addEventListener('click', function() {
        Array.from(droppedPlayerSelect.selectedOptions).forEach(option => {
            const player = droppedPlayers.find(p => p.registration_id === option.value);
            if (player) {
                player.is_current = true;
                droppedPlayers = droppedPlayers.filter(p => p.registration_id !== player.registration_id);
                currentPlayers.push(player);
            }
        });
        renderPlayers();
    });

    function getDroppedOutPlayers() {
        return droppedPlayers.map(player => parseInt(player.seating_id));
    }

    calculateButton.addEventListener('click', async function() {
        const response = await fetch('{{ url_for("run.sub.calculate_substitutions") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dropped_out: getDroppedOutPlayers(),
                fixed_rounds: {{ completed_rounds }},
            })
        });

        if (!response.ok) {
            alert('Error starting calculation');
            return;
        }

        // Then start the EventSource to get progress
        const source = new EventSource('{{ url_for("run.sub.stream_progress") }}');
        previewContent.textContent = "Connecting...\n";
        
        source.onopen = function() {
            console.log('SSE connection opened');
            previewContent.textContent += "Connected to server.\n";
        };
        
        source.onmessage = function(event) {
            console.log('Received SSE message:', event.data);
            try {
                const data = JSON.parse(event.data);
                
                if (data.log) {
                    previewContent.textContent += data.log;
                    previewContent.scrollTop = previewContent.scrollHeight;
                }
                
                if (data.preview) {
                    previewContent.textContent = JSON.stringify(data.preview, null, 2);
                    substitutionPreview.style.display = 'block';
                    source.close();
                }
            } catch (error) {
                console.error('Error processing message:', error, event.data);
                previewContent.textContent += "Error processing message\n";
            }
        };

        source.onerror = function(error) {
            console.error('EventSource failed:', error);
            console.error('ReadyState:', source.readyState);
            previewContent.textContent += "Connection error!\n";
            source.close();
            alert('Error calculating substitutions. Check console for details.');
        };
    });

    confirmButton.addEventListener('click', function() {
        fetch('{{ url_for("run.sub.confirm_substitutions") }}', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Substitutions applied successfully');
                undoButton.style.display = 'block';
                substitutionPreview.style.display = 'none';
                location.reload();
            } else {
                alert('Error applying substitutions');
            }
        });
    });

    cancelButton.addEventListener('click', function() {
        substitutionPreview.style.display = 'none';
    });

    undoButton.addEventListener('click', function() {
        fetch('{{ url_for("run.sub.undo_substitution") }}', {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Last substitution undone');
                location.reload();
            } else {
                alert('Error undoing substitution');
            }
        });
    });
});
</script>
{% endblock %}
