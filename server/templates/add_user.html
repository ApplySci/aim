{% extends "runbase.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<h2>Manage Users for {{ current_user.live_tournament.title }}</h2>

<style>
    table {
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    td:first-child {
        text-align: left;
    }
    td:not(:first-child):not(.actions-column), th:not(:first-child):not(.actions-column) {
        text-align: center;
    }
    .check {
        color: green;
        font-size: 1.2em;
    }
    .cross {
        color: red;
        font-size: 1.2em;
    }
    .current-user {
        font-weight: bold;
        background-color: #e6f3ff !important;
    }
    .btn {
        padding: 5px 10px;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        margin: 2px;
    }
    .btn-remove {
        background-color: #ff4d4d;
        color: white;
    }
    .btn-add {
        background-color: #4da6ff;
        color: white;
    }
    .actions-column {
        text-align: right !important;
    }
    .actions-column button {
        margin-left: 5px;
    }
    .role-select {
        padding: 5px;
        border-radius: 3px;
        border: 1px solid #ddd;
        background-color: white;
    }
    .role-select:disabled {
        background-color: #f2f2f2;
        cursor: not-allowed;
    }
</style>
<fieldset>
<form method="POST">
    {{ form.hidden_tag() }}
    <div>
        {{ form.email.label }}: {{ form.email(size=30) }}
        {% for error in form.email.errors %}
            <span style="color: red;">[{{ error }}]</span>
        {% endfor %}
    </div>
    <div>
        {{ form.role.label }}: {{ form.role() }}
        {% for error in form.role.errors %}
            <span style="color: red;">[{{ error }}]</span>
        {% endfor %}
    </div>
    <div>{{ form.submit() }}</div>
</form>
</fieldset>
<h3>Current Users</h3>
<table id="userTable">
    <thead>
        <tr>
            <th>Email</th>
            <th>Role</th>
            <th>In DB</th>
            <th>In Sheet</th>
            <th class="actions-column">Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for user in users %}
        <tr {% if user.email == current_user_email %}class="current-user"{% endif %}>
            <td>{{ user.email }}</td>
            <td>
                <select class="role-select" data-email="{{ user.email }}" {% if user.email == current_user_email %}disabled{% endif %}>
                    <option value="scorer" {% if user.role == 'scorer' %}selected{% endif %}>Scorer</option>
                    <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
                    {% if is_admin %}
                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                    {% endif %}
                </select>
            </td>
            <td>{% if user.get('in_db', True) %}<span class="check">‚úì</span>{% else %}<span class="cross">‚úó</span>{% endif %}</td>
            <td>{% if user.in_sheet %}<span class="check">‚úì</span>{% else %}<span class="cross">‚úó</span>{% endif %}</td>
            <td class="actions-column">
                {% if is_admin or current_user.email != user.email %}
                    {% if not user.in_sheet %}
                        <button class="btn btn-add" onclick="fixAccess('{{ user.email }}', 'add_to_sheet')">+ Sheet</button>
                    {% endif %}
                    {% if not user.get('in_db', True) %}
                        <button class="btn btn-add" onclick="fixAccess('{{ user.email }}', 'add_to_db')">+ DB</button>
                    {% endif %}
                    {% if user.email != current_user_email %}
                        <button class="btn btn-remove" onclick="fixAccess('{{ user.email }}', 'remove')" title="Remove Access">üóëÔ∏è</button>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<script>
function fixAccess(email, action) {
    fetch('/run/fix_access', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: email,
            action: action,
            tournament_id: {{ current_user.live_tournament_id }}
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Access updated successfully');
            location.reload();
        } else {
            alert('Failed to update access: ' + data.error);
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('An error occurred while updating access');
    });
}

document.querySelectorAll('.role-select').forEach(select => {
    select.addEventListener('change', function() {
        const email = this.dataset.email;
        const newRole = this.value;
        updateUserRole(email, newRole);
    });
});

function updateUserRole(email, newRole) {
    fetch("{{ url_for('user_management.update_user_role') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: email,
            role: newRole,
            tournament_id: {{ current_user.live_tournament_id }}
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Role updated successfully');
        } else {
            alert('Failed to update role: ' + data.error);
            // Reset the select to the previous value
            const select = document.querySelector(`.role-select[data-email="${email}"]`);
            select.value = data.current_role;
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('An error occurred while updating the role');
    });
}
</script>
{% endblock %}
